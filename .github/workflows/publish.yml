name: ğŸš€ Publish ModulaR API

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty for current package.json version)'
        required: false
        type: string
      environment:
        description: 'Deployment environment'
        required: false
        type: choice
        options:
          - production
          - staging
        default: production
      dry_run:
        description: 'Dry run only (no actual publishing)'
        required: false
        type: boolean
        default: false

env:
  BUN_VERSION: '1.2.19'
  NODE_VERSION: '20'

jobs:
  validate:
    name: ğŸ” Validate & Test Package
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.package-info.outputs.version }}
      name: ${{ steps.package-info.outputs.name }}
      should-publish: ${{ steps.package-info.outputs.should-publish }}
    
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better context
        
      - name: âš¡ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¥ Installing dependencies with Bun..."
          bun install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"
          
      - name: ğŸ§¹ Clean previous builds
        run: |
          echo "ğŸ§¹ Cleaning previous builds..."
          bun run clean
          echo "âœ… Clean completed"
          
      - name: ğŸ”¨ Build package
        run: |
          echo "ğŸ”¨ Building package..."
          bun run build
          echo "âœ… Build completed successfully"
          
          echo "ğŸ“ Build output:"
          ls -la dist/
          
      - name: ğŸ§ª Run tests (if available)
        run: |
          if bun run test --help >/dev/null 2>&1; then
            echo "ğŸ§ª Running tests..."
            bun run test
            echo "âœ… Tests passed"
          else
            echo "â„¹ï¸ No test script found, skipping tests"
          fi
        continue-on-error: false
        
      - name: ğŸ“‹ Validate package structure
        run: |
          echo "ğŸ“‹ Validating package structure..."
          bun run publish:dry
          echo "âœ… Package validation passed"
          
          echo ""
          echo "ğŸ“Š Package size analysis:"
          bun run publish:check
          
      - name: ğŸƒ Run benchmarks (optional)
        run: |
          if [ -f "benchmark.js" ]; then
            echo "ğŸƒ Running performance benchmarks..."
            timeout 240s bun run benchmark || echo "âš ï¸ Benchmark timeout or error (non-critical)"
          else
            echo "â„¹ï¸ No benchmark script found, skipping benchmarks"
          fi
        continue-on-error: true
        
      - name: ğŸ“ Extract package info
        id: package-info
        run: |
          VERSION=$(bun -p "require('./package.json').version")
          NAME=$(bun -p "require('./package.json').name")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          
          # Check if this version is already published
          if npm view "$NAME@$VERSION" version >/dev/null 2>&1; then
            echo "should-publish=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Version $VERSION already exists on NPM"
          else
            echo "should-publish=true" >> $GITHUB_OUTPUT
            echo "âœ… Version $VERSION is new and ready for publishing"
          fi
          
          echo "ğŸ“¦ Package: $NAME@$VERSION"
          
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ steps.package-info.outputs.version }}
          path: dist/
          retention-days: 7

  publish:
    name: ğŸš€ Publish to NPM
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-publish == 'true' && github.event.inputs.dry_run != 'true'
    permissions:
      contents: read
      id-token: write # Required for npm provenance
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        
      - name: âš¡ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ needs.validate.outputs.version }}
          path: dist/
          
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¥ Installing dependencies..."
          bun install --frozen-lockfile
          echo "âœ… Dependencies installed"
          
      - name: ğŸ·ï¸ Update version (if specified)
        if: github.event.inputs.version != ''
        run: |
          echo "ğŸ·ï¸ Updating version to ${{ github.event.inputs.version }}..."
          bun -p "
            const pkg = require('./package.json');
            pkg.version = '${{ github.event.inputs.version }}';
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          echo "âœ… Updated version to ${{ github.event.inputs.version }}"
          
      - name: ğŸ” Final package verification
        run: |
          echo "ğŸ” Final package verification:"
          echo ""
          echo "ğŸ“„ Package version:"
          FINAL_VERSION=$(bun -p "require('./package.json').version")
          echo "Version: $FINAL_VERSION"
          
          echo ""
          echo "ğŸ“ Build verification:"
          ls -la dist/
          
          echo ""
          echo "ğŸ“‹ Package contents check:"
          bun run publish:check
          
          echo ""
          echo "ğŸ” Publishing with provenance enabled"
          
      - name: ğŸŒ Publish to NPM
        run: |
          echo "ğŸš€ Publishing ${{ needs.validate.outputs.name }} to NPM..."
          
          # Verify NPM auth
          npm whoami
          
          # Publish with provenance
          npm publish --access public --provenance
          
          echo "âœ… Successfully published to NPM!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          
      - name: ğŸ“¢ Post-publish verification
        run: |
          echo "ğŸ• Waiting for package to propagate on NPM..."
          sleep 45
          
          echo "ğŸ” Verifying published package:"
          PACKAGE_INFO=$(npm view ${{ needs.validate.outputs.name }} --json)
          
          echo "$PACKAGE_INFO" | bun -p "
            const data = JSON.parse(require('fs').readFileSync(0, 'utf8'));
            console.log('âœ… Package verification successful:');
            console.log('   ğŸ“¦ Name:', data.name);
            console.log('   ğŸ·ï¸  Version:', data.version);
            console.log('   ğŸ“ Description:', data.description);
            console.log('   ğŸ“… Published:', new Date(data.time[data.version]).toISOString());
            console.log('   ğŸ“Š Size:', data.dist?.unpackedSize ? (data.dist.unpackedSize / 1024).toFixed(1) + 'KB' : 'Unknown');
            console.log('   ğŸ”— NPM URL: https://www.npmjs.com/package/' + data.name);
          " || echo "âš ï¸ Package verification failed (may take time to propagate)"

  post-publish:
    name: ğŸ“¢ Post-Publish Actions
    runs-on: ubuntu-latest
    needs: [validate, publish]
    if: always() && (needs.publish.result == 'success' || github.event.inputs.dry_run == 'true')
    
    steps:
      - name: ğŸ‰ Success notification
        if: needs.publish.result == 'success' && github.event.inputs.dry_run != 'true'
        run: |
          echo "ğŸ‰ Successfully published ${{ needs.validate.outputs.name }}@${{ needs.validate.outputs.version }}!"
          echo ""
          echo "ğŸ“¦ Package Information:"
          echo "   ğŸ“› Name: ${{ needs.validate.outputs.name }}"
          echo "   ğŸ·ï¸  Version: ${{ needs.validate.outputs.version }}"
          echo "   ğŸŒ Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "   ğŸ“¡ Registry: https://registry.npmjs.org"
          echo ""
          echo "ğŸ“¥ Installation Commands:"
          echo "   bun add ${{ needs.validate.outputs.name }}"
          echo "   npm install ${{ needs.validate.outputs.name }}"
          echo "   yarn add ${{ needs.validate.outputs.name }}"
          echo ""
          echo "ğŸ”— Links:"
          echo "   ğŸ“¦ NPM Package: https://www.npmjs.com/package/${{ needs.validate.outputs.name }}"
          echo "   ğŸ“š Documentation: https://github.com/Lukseh/modular-api#readme"
          echo "   ğŸ› Issues: https://github.com/Lukseh/modular-api/issues"
          
      - name: ğŸ” Dry run summary
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ” Dry Run Completed Successfully!"
          echo ""
          echo "âœ… Package ${{ needs.validate.outputs.name }}@${{ needs.validate.outputs.version }} is ready for publishing"
          echo "ğŸ“‹ All validation checks passed"
          echo "ğŸš€ Ready for production deployment"
          echo ""
          echo "To publish for real, run this workflow again with 'Dry run only' unchecked"
          
      - name: âŒ Publish failure notification
        if: needs.publish.result == 'failure'
        run: |
          echo "âŒ Publishing failed for ${{ needs.validate.outputs.name }}@${{ needs.validate.outputs.version }}"
          echo ""
          echo "ğŸ” Please check the logs above for error details"
          echo "ğŸ› ï¸  Common fixes:"
          echo "   - Verify NPM_TOKEN secret is correctly set"
          echo "   - Check if version already exists on NPM"
          echo "   - Ensure package.json is valid"
          echo "   - Verify build completed successfully"
          
      - name: âš ï¸ Already published notification  
        if: needs.validate.outputs.should-publish == 'false'
        run: |
          echo "âš ï¸ Version ${{ needs.validate.outputs.version }} already exists on NPM"
          echo ""
          echo "ğŸ’¡ To publish a new version:"
          echo "   1. Update version in package.json"
          echo "   2. Create a new release, or"
          echo "   3. Run this workflow manually with a new version number"
          echo ""
          echo "ğŸ”— Current package: https://www.npmjs.com/package/${{ needs.validate.outputs.name }}"
